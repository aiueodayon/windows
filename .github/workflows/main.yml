name: Myrtille Cloudflare Tunnel

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: windows-latest

    steps:
      - name: üß∞ Setup PowerShell
        shell: pwsh
        run: |
          Write-Host "PowerShell version:" $PSVersionTable.PSVersion


      - name: üì¶ Download latest Myrtille MSI
        shell: pwsh
        run: |
          $release = Invoke-RestMethod "https://api.github.com/repos/cedrozor/myrtille/releases/latest"
          $asset = $release.assets | Where-Object { $_.name -like "*.msi" } | Select-Object -First 1
          if (-not $asset) { Write-Error "‚ùå Myrtille MSI not found."; exit 1 }
          Write-Host "Found MSI: $($asset.name)"
          Invoke-WebRequest $asset.browser_download_url -OutFile Myrtille.msi
          Write-Host "‚úÖ Downloaded Myrtille.msi"


      - name: üìÇ Extract MSI to folder (bypass installer)
        shell: pwsh
        run: |
          mkdir C:\Myrtille
          Start-Process msiexec.exe -ArgumentList '/a', (Resolve-Path Myrtille.msi), '/qn', "TARGETDIR=C:\Myrtille" -Wait
          Write-Host "‚úÖ Myrtille extracted to C:\Myrtille"
    

      - name: üöÄ Start Myrtille Web + Services
        shell: pwsh
        run: |
          # Ëá™ÂãïÁöÑ„Å´ Myrtille.exe „ÅÆÂ†¥ÊâÄ„ÇíÊ§úÁ¥¢
          $exePath = Get-ChildItem -Path "C:\Myrtille" -Recurse -Filter "Myrtille.Web.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $exePath) {
            Write-Error "‚ùå Myrtille.Web.exe not found after extraction."
            exit 1
          }
            $base = Split-Path $exePath.FullName
          Write-Host "‚úÖ Myrtille found at: $base"
          cd $base

          if (Test-Path "Myrtille.Services.exe") {
            Start-Process -FilePath "Myrtille.Services.exe" -NoNewWindow
            Write-Host "Started Myrtille.Services.exe"
          } else {
            Write-Warning "‚ö†Ô∏è Myrtille.Services.exe not found (may not be needed)"
          }

          Start-Process -FilePath "Myrtille.Web.exe" -NoNewWindow
          Write-Host "‚úÖ Myrtille.Web.exe started (port 80 expected)"

      
      
      - name: üåê Download Cloudflared
        shell: pwsh
        run: |
          Invoke-WebRequest https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe
          Write-Host "‚úÖ Cloudflared downloaded."


      - name: ‚òÅÔ∏è Start Cloudflare Tunnel
        shell: pwsh
        env:
          CLOUDFLARED_TOKEN: ${{ secrets.CLOUDFLARED_TOKEN }}
        run: |
          if (-not $env:CLOUDFLARED_TOKEN) {
            Write-Error "‚ùå CLOUDFLARED_TOKEN secret not set. Add it in your repository settings."
            exit 1
          }
          Write-Host "Installing Cloudflared service..."
          .\cloudflared.exe service install $env:CLOUDFLARED_TOKEN
          Start-Sleep -Seconds 8
          Write-Host "‚úÖ Tunnel installation attempted. Check your Cloudflare dashboard for the active URL."

      - name: ‚úÖ Done
        shell: pwsh
        run: |
          Write-Host "üéâ Myrtille + Cloudflare tunnel setup complete!"
