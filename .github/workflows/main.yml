name: BrowserRDP
on: workflow_dispatch

jobs:
  rdp:
    runs-on: windows-latest
    steps:
      - name: Enable RDP and create user
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          net user runner Password123! /add
          net localgroup administrators runner /add
          Write-Host "‚úÖ RDP enabled and user created."

      - name: Download Myrtille (auto detect latest)
        shell: pwsh
        run: |
          $release = Invoke-RestMethod "https://api.github.com/repos/cedrozor/myrtille/releases/latest"
          $asset = $release.assets | Where-Object { $_.name -like "Myrtille-*.zip" } | Select-Object -First 1
          if (-not $asset) { Write-Error "‚ùå Myrtille ZIP not found in latest release."; exit 1 }
          Invoke-WebRequest $asset.browser_download_url -OutFile Myrtille.zip
          Expand-Archive Myrtille.zip -DestinationPath C:\Myrtille
          Write-Host "‚úÖ Myrtille downloaded and extracted."

      - name: Start Myrtille Web + Services
        run: |
          cd C:\Myrtille
          Start-Process -FilePath "C:\Myrtille\Myrtille.Services.exe"
          Start-Process -FilePath "C:\Myrtille\Myrtille.Web.exe"
          Write-Host "‚úÖ Myrtille started on port 80."

      - name: Download Cloudflared
        shell: pwsh
        run: |
          Invoke-WebRequest https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe
          Write-Host "‚úÖ Cloudflared downloaded."

      - name: Start Cloudflare Tunnel
        env:
          CLOUDFLARED_TOKEN: ${{ secrets.CLOUDFLARED_TOKEN }}
        shell: pwsh
        run: |
          .\cloudflared.exe service install $env:CLOUDFLARED_TOKEN
          Start-Sleep -Seconds 10
          Write-Host "üåê Tunnel started ‚Äî open your Cloudflare dashboard to get the public URL."
          Write-Host "ü™ü Then log in via Myrtille (browser RDP gateway)."
          Write-Host "User: runner / Password: Password123!"
          Write-Host "‚ö†Ô∏è The session will expire when the job ends (max ~6h)."
