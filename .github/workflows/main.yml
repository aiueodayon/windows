name: Myrtille Cloudflare Tunnel

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: windows-latest

    steps:
      - name: üß∞ Setup PowerShell
        shell: pwsh
        run: |
          Write-Host "PowerShell version:" $PSVersionTable.PSVersion
          Write-Host "Windows version:" (Get-ComputerInfo).WindowsProductName

      # --- Download MSI installer from GitHub ---
      - name: üì¶ Download latest Myrtille MSI
        shell: pwsh
        run: |
          $release = Invoke-RestMethod "https://api.github.com/repos/cedrozor/myrtille/releases/latest"
          $asset = $release.assets | Where-Object { $_.name -match "Myrtille_.*Setup\.msi" } | Select-Object -First 1
          if (-not $asset) {
            Write-Error "‚ùå Myrtille MSI not found in release."
            exit 1
          }
          Write-Host "Found MSI: $($asset.name)"
          Invoke-WebRequest $asset.browser_download_url -OutFile Myrtille.msi -UseBasicParsing
          Write-Host "‚úÖ Downloaded Myrtille.msi"

      # --- Extract MSI contents into C:\Myrtille ---
      - name: üìÇ Extract MSI contents
        shell: pwsh
        run: |
          $target = "C:\Myrtille"
          if (Test-Path $target) { Remove-Item -Recurse -Force $target }
          New-Item -ItemType Directory -Path $target | Out-Null

          Start-Process msiexec.exe -ArgumentList '/a', (Resolve-Path Myrtille.msi), '/qn', "TARGETDIR=$target" -Wait
          Write-Host "‚úÖ Extracted to $target"

          # Á¢∫Ë™ç
          Get-ChildItem -Path $target -Recurse -Filter "Myrtille.Web.exe" | ForEach-Object { Write-Host "üìÑ Found:" $_.FullName }

      # --- Run Myrtille (auto-detect install path) ---
      - name: üöÄ Start Myrtille Web + Services
        shell: pwsh
        run: |
          $searchPaths = @(
            "C:\Myrtille",
            "C:\Program Files\Myrtille",
            "C:\Program Files (x86)\Myrtille"
          )

          $exePath = $null
          foreach ($path in $searchPaths) {
            if (Test-Path $path) {
              $found = Get-ChildItem -Path $path -Recurse -Filter "Myrtille.Web.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($found) {
                $exePath = $found.FullName
                break
              }
            }
          }

          if (-not $exePath) {
            Write-Error "‚ùå Myrtille.Web.exe not found in any of: $($searchPaths -join ', ')"
            exit 1
          }

          $base = Split-Path $exePath
          Write-Host "‚úÖ Myrtille found at: $base"
          cd $base

          if (Test-Path "Myrtille.Services.exe") {
            Start-Process -FilePath "Myrtille.Services.exe" -NoNewWindow
            Write-Host "üü¢ Started Myrtille.Services.exe"
          } else {
            Write-Warning "‚ö†Ô∏è Myrtille.Services.exe not found (may not be needed)"
          }

          Start-Process -FilePath "Myrtille.Web.exe" -NoNewWindow
          Write-Host "üü¢ Myrtille.Web.exe started (port 80 expected)"
          Start-Sleep -Seconds 5

          Write-Host "‚úÖ Myrtille processes running:"
          Get-Process | Where-Object { $_.ProcessName -match "Myrtille" } | Select-Object ProcessName, Id

      # --- Cloudflared setup ---
      - name: üåê Download Cloudflared
        shell: pwsh
        run: |
          Invoke-WebRequest https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe
          Write-Host "‚úÖ Cloudflared downloaded."

      - name: ‚òÅÔ∏è Start Cloudflare Tunnel
        shell: pwsh
        env:
          CLOUDFLARED_TOKEN: ${{ secrets.CLOUDFLARED_TOKEN }}
        run: |
          if (-not $env:CLOUDFLARED_TOKEN) {
            Write-Error "‚ùå CLOUDFLARED_TOKEN secret not set. Add it in your repository settings."
            exit 1
          }

          Write-Host "Installing Cloudflared service..."
          .\cloudflared.exe service install $env:CLOUDFLARED_TOKEN

          Write-Host "‚úÖ Cloudflared service installed."
          Start-Sleep -Seconds 8

          Write-Host "‚ö° Checking Cloudflared process..."
          Get-Process | Where-Object { $_.ProcessName -match "cloudflared" } | Select-Object ProcessName, Id

      - name: ‚úÖ Done
        shell: pwsh
        run: |
          Write-Host "üéâ Myrtille + Cloudflare tunnel setup complete!"
