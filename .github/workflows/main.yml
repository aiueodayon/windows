name: Myrtille Cloudflare Tunnel

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: windows-latest

    steps:
      - name: üß∞ Setup PowerShell
        shell: pwsh
        run: |
          Write-Host "PowerShell version:" $PSVersionTable.PSVersion

      - name: üì¶ Download latest Myrtille MSI
        shell: pwsh
        run: |
          $release = Invoke-RestMethod "https://api.github.com/repos/cedrozor/myrtille/releases/latest"
          $asset = $release.assets | Where-Object { $_.name -like "*.msi" } | Select-Object -First 1
          if (-not $asset) { Write-Error "‚ùå Myrtille MSI not found."; exit 1 }
          Write-Host "Found MSI: $($asset.name)"
          Invoke-WebRequest $asset.browser_download_url -OutFile Myrtille.msi
          Write-Host "‚úÖ Downloaded Myrtille.msi"

      - name: ‚öôÔ∏è Install Myrtille silently
        shell: pwsh
        run: |
          Write-Host "Installing Myrtille..."
          $proc = Start-Process -FilePath msiexec.exe -ArgumentList '/i', (Resolve-Path Myrtille.msi), '/qn', '/norestart' -Wait -PassThru
          if ($proc.ExitCode -ne 0) { Write-Error "‚ùå Installation failed: exit code $($proc.ExitCode)"; exit $proc.ExitCode }
          Write-Host "‚úÖ Myrtille installed successfully."

      - name: üîç Locate Myrtille install path
        id: findpath
        shell: pwsh
        run: |
          $candidates = @(
            'C:\Program Files\Myrtille',
            'C:\Program Files (x86)\Myrtille',
            'C:\Myrtille'
          )
          $path = $candidates | Where-Object { Test-Path $_ } | Select-Object -First 1
          if (-not $path) {
            $path = (Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*" | Where-Object { $_.DisplayName -like "*Myrtille*" } | Select-Object -ExpandProperty InstallLocation -ErrorAction SilentlyContinue)
          }
          if (-not $path) {
            Write-Warning "‚ö†Ô∏è Myrtille install path not found."
            exit 1
          }
          Write-Host "‚úÖ Myrtille found at: $path"
          echo "MYRTILLE_PATH=$path" >> $env:GITHUB_ENV

      - name: üöÄ Start Myrtille services
        shell: pwsh
        run: |
          $path = $env:MYRTILLE_PATH
          $svc = Join-Path $path "Myrtille.Services.exe"
          $web = Join-Path $path "Myrtille.Web.exe"

          if (Test-Path $svc) {
            Start-Process -FilePath $svc -NoNewWindow
            Write-Host "Started Myrtille.Services.exe"
          } else {
            Write-Warning "Service exe not found at $svc"
          }

          if (Test-Path $web) {
            Start-Process -FilePath $web -NoNewWindow
            Write-Host "Started Myrtille.Web.exe"
          } else {
            Write-Warning "Web exe not found at $web"
          }

          Start-Sleep -Seconds 10
          Write-Host "‚úÖ Myrtille should now be running (likely on http://localhost/)"

      - name: üåê Download Cloudflared
        shell: pwsh
        run: |
          Invoke-WebRequest https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe
          Write-Host "‚úÖ Cloudflared downloaded."

      - name: ‚òÅÔ∏è Start Cloudflare Tunnel
        shell: pwsh
        env:
          CLOUDFLARED_TOKEN: ${{ secrets.CLOUDFLARED_TOKEN }}
        run: |
          if (-not $env:CLOUDFLARED_TOKEN) {
            Write-Error "‚ùå CLOUDFLARED_TOKEN secret not set. Add it in your repository settings."
            exit 1
          }
          Write-Host "Installing Cloudflared service..."
          .\cloudflared.exe service install $env:CLOUDFLARED_TOKEN
          Start-Sleep -Seconds 8
          Write-Host "‚úÖ Tunnel installation attempted. Check your Cloudflare dashboard for the active URL."

      - name: ‚úÖ Done
        shell: pwsh
        run: |
          Write-Host "üéâ Myrtille + Cloudflare tunnel setup complete!"
