- name: Download Myrtille MSI (auto detect latest)
  shell: pwsh
  run: |
    # GitHub Releases API „Åã„ÇâÊúÄÊñ∞„É™„É™„Éº„Çπ„ÅÆË≥áÁî£„ÇíÂèñÂæó„Åó„Å¶ *.msi „ÇíÊé¢„Åô
    $release = Invoke-RestMethod "https://api.github.com/repos/cedrozor/myrtille/releases/latest"
    $asset = $release.assets | Where-Object { $_.name -like "*.msi" } | Select-Object -First 1
    if (-not $asset) { Write-Error "‚ùå Myrtille MSI not found in latest release."; exit 1 }
    Write-Host "Found MSI: $($asset.name)"
    Invoke-WebRequest $asset.browser_download_url -OutFile Myrtille.msi

- name: Install Myrtille MSI (silent)
  shell: pwsh
  run: |
    # „Çµ„Ç§„É¨„É≥„Éà„Ç§„É≥„Çπ„Éà„Éº„É´ÔºàÁµÇ‰∫Ü„Ç≥„Éº„Éâ„ÇíÁ¢∫Ë™çÔºâ
    $exit = Start-Process -FilePath msiexec.exe -ArgumentList '/i', (Resolve-Path Myrtille.msi), '/qn', '/norestart' -Wait -PassThru
    if ($exit.ExitCode -ne 0) { Write-Error "‚ùå msiexec failed with exit code $($exit.ExitCode)"; exit $exit.ExitCode }
    Write-Host "‚úÖ Myrtille MSI installed (exit $($exit.ExitCode))."

- name: Find Myrtille install path & start services
  shell: pwsh
  run: |
    # „Çà„Åè„ÅÇ„Çã„Ç§„É≥„Çπ„Éà„Éº„É´ÂÖàÂÄôË£ú„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶ÂÆüË°å„Éê„Ç§„Éä„É™„ÇíÊé¢„Åô
    $candidates = @(
      'C:\Program Files\Myrtille',
      'C:\Program Files (x86)\Myrtille',
      'C:\Myrtille'
    )
    $installed = $candidates | Where-Object { Test-Path $_ } | Select-Object -First 1
    if (-not $installed) {
      # MSI „ÅåÂà•„Éë„Çπ„Å´ÂÖ•„Å£„ÅüÂèØËÉΩÊÄß„Åå„ÅÇ„Çã -> MSI „ÅÆ„Éó„É≠„Éë„ÉÜ„Ç£„ÇíË™≠„Çì„Åß„Åø„Çã
      $installed = (Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*" | Where-Object { $_.DisplayName -like "*Myrtille*" } | Select-Object -First 1).InstallLocation
    }
    if (-not $installed) {
      Write-Warning "‚ö†Ô∏è Myrtille install path not found automatically. Listing C:\\ for troubleshooting."
      Get-ChildItem -Path C:\ -Directory -Depth 2 | Where-Object Name -like "*Myrtille*"
      exit 0
    }
    Write-Host "Myrtille detected at: $installed"

    # „Çµ„Éº„Éì„ÇπÔºèÂÆüË°å„Éï„Ç°„Ç§„É´„ÇíËµ∑Âãï
    $svc = Join-Path $installed "Myrtille.Services.exe"
    $web = Join-Path $installed "Myrtille.Web.exe"

    if (Test-Path $svc) {
      Start-Process -FilePath $svc -NoNewWindow -PassThru | Out-Null
      Write-Host "Started Myrtille.Services.exe"
    } else {
      Write-Warning "Myrtille.Services.exe not found at $svc"
    }

    if (Test-Path $web) {
      Start-Process -FilePath $web -NoNewWindow -PassThru | Out-Null
      Write-Host "Started Myrtille.Web.exe"
    } else {
      Write-Warning "Myrtille.Web.exe not found at $web"
    }

- name: Download Cloudflared
  shell: pwsh
  run: |
    Invoke-WebRequest https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe
    Write-Host "‚úÖ Cloudflared downloaded."

- name: Start Cloudflare Tunnel
  env:
    CLOUDFLARED_TOKEN: ${{ secrets.CLOUDFLARED_TOKEN }}
  shell: pwsh
  run: |
    .\cloudflared.exe service install $env:CLOUDFLARED_TOKEN
    Start-Sleep -Seconds 8
    Write-Host "üåê Tunnel attempted to start. Check Cloudflare Tunnels dashboard for the public URL."
